<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Walkingsimulator</title>

        <!-- Babylon.js -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        
        <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/ammo.js"></script>
        <script src="https://preview.babylonjs.com/cannon.js"></script>
        <script src="https://preview.babylonjs.com/Oimo.js"></script>
        <script src="https://preview.babylonjs.com/gltf_validator.js"></script>
        <script src="https://preview.babylonjs.com/earcut.min.js"></script>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
        <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
            
            
        </style>
    </head>
    <body>
        <canvas id="renderCanvas"></canvas>

        <script>
            !function(A,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.NoSleep=e():A.NoSleep=e()}("undefined"!=typeof self?self:this,function(){return function(A){function e(B){if(o[B])return o[B].exports;var Q=o[B]={i:B,l:!1,exports:{}};return A[B].call(Q.exports,Q,Q.exports,e),Q.l=!0,Q.exports}var o={};return e.m=A,e.c=o,e.d=function(A,o,B){e.o(A,o)||Object.defineProperty(A,o,{configurable:!1,enumerable:!0,get:B})},e.n=function(A){var o=A&&A.__esModule?function(){return A.default}:function(){return A};return e.d(o,"a",o),o},e.o=function(A,e){return Object.prototype.hasOwnProperty.call(A,e)},e.p="",e(e.s=0)}([function(A,e,o){"use strict";function B(A,e){if(!(A instanceof e))throw new TypeError("Cannot call a class as a function")}var Q=function(){function A(A,e){for(var o=0;o<e.length;o++){var B=e[o];B.enumerable=B.enumerable||!1,B.configurable=!0,"value"in B&&(B.writable=!0),Object.defineProperty(A,B.key,B)}}return function(e,o,B){return o&&A(e.prototype,o),B&&A(e,B),e}}(),t=o(1),n=t.webm,c=t.mp4,E="undefined"!=typeof navigator&&parseFloat((""+(/CPU.*OS ([0-9_]{3,4})[0-9_]{0,1}|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))<10&&!window.MSStream,l=function(){function A(){var e=this;B(this,A),E?this.noSleepTimer=null:(this.noSleepVideo=document.createElement("video"),this.noSleepVideo.setAttribute("muted",""),this.noSleepVideo.setAttribute("title","No Sleep"),this.noSleepVideo.setAttribute("playsinline",""),this._addSourceToVideo(this.noSleepVideo,"webm",n),this._addSourceToVideo(this.noSleepVideo,"mp4",c),this.noSleepVideo.addEventListener("loadedmetadata",function(){e.noSleepVideo.duration<=1?e.noSleepVideo.setAttribute("loop",""):e.noSleepVideo.addEventListener("timeupdate",function(){e.noSleepVideo.currentTime>.5&&(e.noSleepVideo.currentTime=Math.random())})}))}return Q(A,[{key:"_addSourceToVideo",value:function(A,e,o){var B=document.createElement("source");B.src=o,B.type="video/"+e,A.appendChild(B)}},{key:"enable",value:function(){E?(this.disable(),console.warn("\n        NoSleep enabled for older iOS devices. This can interrupt\n        active or long-running network requests from completing successfully.\n        See https://github.com/richtr/NoSleep.js/issues/15 for more details.\n      "),this.noSleepTimer=window.setInterval(function(){document.hidden||(window.location.href=window.location.href.split("#")[0],window.setTimeout(window.stop,0))},15e3)):this.noSleepVideo.play()}},{key:"disable",value:function(){E?this.noSleepTimer&&(console.warn("\n          NoSleep now disabled for older iOS devices.\n        "),window.clearInterval(this.noSleepTimer),this.noSleepTimer=null):this.noSleepVideo.pause()}}]),A}();A.exports=l},function(A,e,o){"use strict";A.exports={webm:"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=",mp4:"data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC8wYF///v3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0MiByMjQ3OSBkZDc5YTYxIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNCAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTEgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MToweDExMSBtZT1oZXggc3VibWU9MiBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0wIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MCA4eDhkY3Q9MCBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0wIHRocmVhZHM9NiBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBiZnJhbWVzPTMgYl9weXJhbWlkPTIgYl9hZGFwdD0xIGJfYmlhcz0wIGRpcmVjdD0xIHdlaWdodGI9MSBvcGVuX2dvcD0wIHdlaWdodHA9MSBrZXlpbnQ9MzAwIGtleWludF9taW49MzAgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD0xMCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIwLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IHZidl9tYXhyYXRlPTIwMDAwIHZidl9idWZzaXplPTI1MDAwIGNyZl9tYXg9MC4wIG5hbF9ocmQ9bm9uZSBmaWxsZXI9MCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAAOWWIhAA3//p+C7v8tDDSTjf97w55i3SbRPO4ZY+hkjD5hbkAkL3zpJ6h/LR1CAABzgB1kqqzUorlhQAAAAxBmiQYhn/+qZYADLgAAAAJQZ5CQhX/AAj5IQAD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"}}])});
                var isPC = false;
                var isMobile = false;
                 //initiate as false
                // device detection
                if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
                    || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) { 
                    isMobile = true;
                }else{
                    isPC = true;
                }

            var canvas = document.getElementById("renderCanvas");

            
            /////Naame_Prefix benötigt den richtigen namen des Meshes, welche vom Raycast erkannt werden sollen
            var FLOOR_NAME_PREFIX = "RayCastTarget";
            var FLOORInvisible_NAME_PREFIX = "RayCastTargetInvisible";
            //var WALL_NAME_PREFIX = "Wall";
            var meshTask = [];
            var haloCenter = new BABYLON.Vector3(0, 0, 0);
            var rayTargetMesh = null;
            var teleportationCircle = null;
            var rayTarget = true;
            var isFloor = false;
            var isWall = false;
            var ground;
            var wall;
            var camera;
            var cam;
            var timer = 0;
            var waitingTime = 5000;
            var buttonsEnabled;
            var button1;
            var button2;
            var  bullets = [];
            var left, right, middle;
            left = 0;
            middle = 1;
            right = 2;
            var vrHelper;
            var isXRDeviceandBrowser = window.navigator.xr;


//////////////////////////////////////EvosparkSplash//////////////////////////////////////
            ///Für Mobile Geräte--> Skalierung des Splashscreen nicht korrekt
            var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
            BABYLON.DefaultLoadingScreen.prototype.displayLoadingUI = function () {
                if (this._loadingDiv) {
                    // Do not add a loading screen if there is already one
                    return;
                }
                this._loadingDiv = document.createElement("div");
                this._loadingDiv.id = "babylonjsLoadingDiv";
                this._loadingDiv.style.opacity = "0";
                this._loadingDiv.style.transition = "opacity 1.5s ease";
                this._loadingDiv.style.pointerEvents = "none";
            
                var imgBack = new Image();
                imgBack.src = "https://dl.dropbox.com/s/f3u780qoeohdxfw/beispiel1.gif?dl=0";
                imgBack.style.position = "absolute";
                imgBack.style.height = "100%";
                imgBack.style.width = "100%";
                
                this._loadingDiv.appendChild(imgBack);
                this._resizeLoadingUI();
                window.addEventListener("resize", this._resizeLoadingUI);
                this._loadingDiv.style.backgroundColor = this._loadingDivBackgroundColor;
                document.body.appendChild(this._loadingDiv);
                this._loadingDiv.style.opacity = "1";
            };
        
            BABYLON.DefaultLoadingScreen.prototype.hideLoadingUI = function(){
                this._loadingDiv.style.display = "none";
                console.log("scene is now loaded");
            }


///////////////////////////////////Ende////EvosparkSplash//////////////////////////////////////

//////////////////////////////////////MainSzene erstellen//////////////////////////////////////

            var createScene = function() {

                engine.displayLoadingUI();

                var mainScene = new BABYLON.Scene(engine);
                mainScene.clearColor = new BABYLON.Color3(1, 1, 1);
                
                if(isMobile){
                     cam = new BABYLON.DeviceOrientationCamera("camera1", new BABYLON.Vector3(5, 1.5, 0), mainScene);
                     cam.enableHorizontalDragging(-0.001);
                }
                else{
                    cam = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(5, 1.5, 0), mainScene);
                }
                cam.rotation.x = 0.0035;
                cam.rotation.y = -1.6;
                cam.rotation.z = 0;
                cam.angularSensibility = -10000;
                cam.attachControl(canvas, true);
                


                ////OrbitViewKamera
                var camArc = new BABYLON.ArcRotateCamera("camera1", 1, 1, 80, BABYLON.Vector3.Zero(), mainScene);
                camArc.lowerRadiusLimit = 1;
                camArc.upperRadiusLimit = 500;
                camArc.attachControl(canvas, true);


                var light = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1, 0), mainScene);
                light.intensity = 0.7;
                var light2 = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,-1, 0), mainScene);
                light2.intensity = 0.3;

                ////Model laden
                var meshTask = BABYLON.SceneLoader.Append("https://dl.dropbox.com/s/3aav15a0ottk7fk/FinalRoomReduce.glb?dl=0", "FinalRoomReduce.glb", mainScene, function (mainScene) {
                
                ////Treppe nutzt eine Plane diese wird auf unsichbar gesetzt
                ////Indicator sind die Namen der Meshes
                    for (var i = 0; i < scene.meshes.length; i++) {
                        if(scene.meshes[i].name.includes("RayCastTargetInvisible")){
                        scene.meshes[i].visibility = 0;
                        }
                    }
                    
                    //Sobald Szene fertig geladen wurde soll SplashScreen ausgeblendet werden
                    //Erstellung der VR komponenten und Kameraanpassungen
                    scene.executeWhenReady(function () {
                        engine.hideLoadingUI();
                        initializeClickSimulator(scene);

                        //////Update funktion wird für jeden Frame ausgeführt
                        scene.registerBeforeRender(function () {
                            if (rayTarget == true){

                                //Nutze für Mobile angepasste Steuerung
                                if(isMobile){
                                    simulateClick(scene);  
                                    console.log("ismob")  ;
                                }
                                 //Nutze für PC angepasste Steuerung
                                if(isPC){
                                    raytoMousePos(scene);

                                    console.log("ispc")  ;
                                }
                            }
                        });
                       
                    });             
                });

        
//////////////////////////////////////Buttons//////////////////////////////////////
                var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
                button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Orbit");
                button1.width = "150px"
                button1.height = "40px";
                button1.color = "Black";
                button1.cornerRadius = 5;
                button1.background = "white";
                button1.left = "43%";
                button1.top ="50px";
                button1.isVisible = true;
                button1.onPointerDownObservable.add(function() {
                    scene.activeCamera = camArc;
                    rayTargetMesh.visibility = 0;
                    rayTarget = false;
                    teleportationCircle.visibility = 0;
                    for (var i = 0; i < scene.meshes.length; i++) {
                        if(scene.meshes[i].name.includes("Boden.017")){
                            scene.meshes[i].visibility = 0;
                        }
                    }
                    button1.isVisible = false;
                    button2.isVisible = true;
                    hideTeleportationCircle(teleportationCircle);
                });
                advancedTexture.addControl(button1);    

                button2 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Walking");
                
                button2.width = "150px"
                button2.height = "40px";
                button2.color = "Black";
                button2.cornerRadius = 5;
                button2.background = "white";
                button2.left = "43%";
                button2.top ="50px";
                button2.isVisible = false;
                button2.onPointerDownObservable.add(function() {
                    scene.activeCamera = cam;
                    rayTargetMesh.visibility = 1;
                    rayTarget = true;
                    teleportationCircle.visibility = 1;
                    for (var i = 0; i < scene.meshes.length; i++) {
                        if(scene.meshes[i].name.includes("Boden.017")){
                            scene.meshes[i].visibility = 1;
                        }
                    }
                    button1.isVisible = true;
                    button2.isVisible = false;
                    displayTeleportationCircle(teleportationCircle);
                });
                advancedTexture.addControl(button2);    


                button3 = BABYLON.GUI.Button.CreateSimpleButton("but1", "AR");
                
                button3.width = "150px"
                button3.height = "40px";
                button3.color = "Black";
                button3.cornerRadius = 5;
                button3.background = "white";
                button3.left = "43%";
                button3.top ="-47%";
                button3.isVisible = true;
                button3.onPointerDownObservable.add(function() {
                    window.open("Scene-Viewer.html");
                });
                advancedTexture.addControl(button3);
////////////////////////Ende////Buttons//////////////////////////////////////
                return mainScene;
            };
 //////////////////////////Ende///////MainSzene erstellen//////////////////////////////////////
           
        //////Problem mit der WebVR-API Umstieg auf WebXR
        //////WebXR Sitzung muss async gesetzt werden
            async function initializeClickSimulator(scene) {
                
                rayTargetMesh = createRayTargetMesh();
                teleportationCircle = createTeleportationCircles(scene);
                if(isMobile){
                    const xrHelper = await scene.createDefaultXRExperienceAsync({
                        disableTeleportation: true
                    });
                    xrHelper.pointerSelection.detach();
                    if (!xrHelper.baseExperience) {
                        console.log("noXRSupported");
                    } else {
                        console.log("XRSupported");
                    }  
                    
                    xrHelper.baseExperience.sessionManager.onXRSessionInit.add(() => {
                        scene.getEngine().isPointerLock = true;
                        scene.activeCamera = camera;
                        rayTargetMesh.visibility = 1;
                        rayTarget = true;
                        teleportationCircle.visibility = 1;
                        for (var i = 0; i < scene.meshes.length; i++) {
                            if(scene.meshes[i].name.includes("Boden.017")){
                                scene.meshes[i].visibility = 1;
                            }
                        }
                        button1.isVisible = false;
                        button2.isVisible = false;

                    });
                    ///Fur leave oder end VR/XR Session
                    xrHelper.baseExperience.sessionManager.onXRSessionEnded.add(() => {
                        scene.getEngine().isPointerLock = false;
                        rayTargetMesh.visibility = 1;
                        button1.isVisible = true;
                        button2.isVisible = false;
                    });
                }
            }
            

            /////////Clicksimulator für Mobile Endgeräte
            /////////Überprüft ob eine Bodenfläche getroffen wird um zu teleportieren
            /////////Wenn keine Bodenfläche getroffen wurde teleportieren Abbrechen
            function simulateClick(scene) {
                camera = scene.activeCamera;
                rayTargetMesh.parent = camera;
                rayTargetMesh.position.z = 1.1;
                var ray = camera.getForwardRay();

                var hit = scene.pickWithRay(ray);
                if (!hit.pickedMesh) {
                    hideTeleportationCircle(teleportationCircle);
                    return;
                }
                isFloor = false;
                //isWall = false;
                
                var mesh = hit.pickedMesh;

                if ( FLOORInvisible_NAME_PREFIX || mesh.name.startsWith(FLOOR_NAME_PREFIX)) {
                    if (mesh.name.startsWith(FLOOR_NAME_PREFIX) || mesh.name.startsWith(FLOORInvisible_NAME_PREFIX)) {
                        isFloor = true;
                    }
                }

                if (!isFloor) {
                    hideTeleportationCircle(teleportationCircle);
                    setProgress(0);
                    timer = 0;
                    return;
                }

                if (isFloor) {
                    displayTeleportCircle(hit, teleportationCircle, haloCenter)
                }
                else {
                    hideTeleportationCircle(teleportationCircle);
                }

                if (isFloor && timer < waitingTime) { 
                    timer += scene.getEngine().getDeltaTime();   
                    setProgress(timer / waitingTime);
                }
                else
                {
                    if(timer >= waitingTime)
                    teleportCamera(camera, scene, haloCenter);
                    timer = 0;
                    setProgress(0);
                }
                return false;       
            }

            //////////////////////Teleportation für PC
            /////////////////////Mausposition als Teleportationsziel
            function raytoMousePos(scene){
                camera = cam;
                camera.angularSensibility = -10000;
                var hit = scene.pick(scene.pointerX, scene.pointerY);
                if (!hit.pickedMesh) {
                    hideTeleportationCircle(teleportationCircle);
                    return;
                }

        
                isFloor = false;
                isWall = false;

                var mesh = hit.pickedMesh;
                if ( FLOORInvisible_NAME_PREFIX || mesh.name.startsWith(FLOOR_NAME_PREFIX)) {
                        if (mesh.name.startsWith(FLOOR_NAME_PREFIX) || mesh.name.startsWith(FLOORInvisible_NAME_PREFIX)) {
                            isFloor = true;
                        }
                }  

                if (!isFloor) {
                    hideTeleportationCircle(teleportationCircle);
                    return;
                }   

                if (isFloor) {
                    displayTeleportCircle(hit, teleportationCircle, hit.pickedPoint)
                }
                else {
                    hideTeleportationCircle(teleportationCircle);
                }

                
                scene.onPointerDown = function (evt, pickResult) {
                    if (isFloor && evt.button === left){
                        teleportCameratoMouse(camera, scene, hit.pickedPoint);    
                    }
                }   

            }

//////////////////////Ladeanzeige für Teleportationseinleitung

            function createRayTargetMesh() {
                
                var target = BABYLON.Mesh.CreatePlane("targetViewVR");
                var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(target, 2048, 2048);
                var circle = new BABYLON.GUI.Ellipse();
                circle.width = "100px";
                circle.height = "100px";
                circle.color = "white";
                circle.thickness = 20;
                advancedTexture.addControl(circle);
                target.isPickable = false;               


                bullets = [];
                var total = 12;
                for (i = 0; i < total; i++){
                    var bullet = new BABYLON.GUI.Ellipse();
                    bullet.width = "30px";
                    bullet.height = "30px";
                    bullet.thickness = 20;
                    bullet.color = "white";
                    bullet.top = -150 * Math.cos(i / total * Math.PI * 2);
                    bullet.left = 150 * Math.sin(i / total * Math.PI * 2);
               
                    advancedTexture.addControl(bullet);
                    bullets.push(bullet);
                }
                bullets.parent = circle;

                return target;
            };

            function setProgress(value){
                // 0 <= value <= 1
                var numberOfBulletsToShow = bullets.length * value;

                for (i = 0; i < bullets.length; i++){
                    if (i < numberOfBulletsToShow)
                        bullets[i].isVisible = true;
                    else
                        bullets[i].isVisible = false;
                }

            }

            //Animierte Kreise, welche das Teleportationsziel anzeigen
            function createTeleportationCircles(scene) {
                var teleportationCircle = BABYLON.Mesh.CreateGround("teleportationCircle", 2, 2, 2, scene);
                var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(teleportationCircle, 1024, 1024);

                var circle = new BABYLON.GUI.Ellipse();
                circle.width = "500px";
                circle.color = "white";
                circle.thickness = 50;
                circle.height = "500px";
                circle.isPickable = false;
                advancedTexture.addControl(circle);

                var innerTeleportationCircle = BABYLON.Mesh.CreateGround("innerTeleportationCircle", 2, 2, 2, scene);
                innerTeleportationCircle.parent = teleportationCircle;
                var advancedTexture2 = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(innerTeleportationCircle, 1024, 1024);
                innerTeleportationCircle.isPickable = false;

                var circle2 = new BABYLON.GUI.Ellipse();
                circle2.width = "400px";
                circle2.color = "grey";
                circle2.thickness = 40;
                circle2.height = "400px";
                circle2.isPickable = false;
                advancedTexture2.addControl(circle2);

                var animationInnerCircle = new BABYLON.Animation("animationInnerCircle", "position.y", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
                animationInnerCircle.isPickable = false;
                var keys = [];
                keys.push({
                    frame: 0,
                    value: 0.01
                });
                keys.push({
                    frame: 30,
                    value: 0.2
                });
                keys.push({
                    frame: 60,
                    value: 0.01
                });

                animationInnerCircle.setKeys(keys);

                var easingFunction = new BABYLON.SineEase();
                easingFunction.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT);
                animationInnerCircle.setEasingFunction(easingFunction);

                innerTeleportationCircle.animations = [];
                innerTeleportationCircle.animations.push(animationInnerCircle);

                scene.beginAnimation(innerTeleportationCircle, 0, 60, true);
                teleportationCircle.isVisible = false;
                teleportationCircle.getChildren()[0].isVisible = false;
                teleportationCircle.isPickable = false;
                return teleportationCircle;
            }

            function displayTeleportCircle(pickingInfo, teleportationCircle, haloCenter) {
                moveTeleportationSelectorTo(teleportationCircle, pickingInfo.pickedPoint)
                haloCenter.copyFrom(pickingInfo.pickedPoint);

                displayTeleportationCircle(teleportationCircle);
            }

            function displayTeleportationCircle(teleportationCircle) {
                teleportationCircle.isVisible = true;
                teleportationCircle.getChildren()[0].isVisible = true;
            }

            function hideTeleportationCircle(teleportationCircle) {
                teleportationCircle.isVisible = false;
                teleportationCircle.getChildren()[0].isVisible = false;
            }

            function moveTeleportationSelectorTo(teleportationCircle, coordinates) {
                teleportationCircle.position = coordinates;
                teleportationCircle.position.y += 0.001;
            }

///////////////////Kamera Teleportationanimation///////////////////////////////////////
            /////Animation für Mobile Geräte
            function teleportCamera(camera, scene, haloCenter) {
                camera.animations = [];

                ////////////Trennung der Animation für x,y,z Koordinaten um für die Y-Koordinate eine Höhe hinzuzufügen
                var animationZoomIn = new BABYLON.Animation("animationZoomIn", "position.x", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT,
                    BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                var keys = [];
                keys.push({
                    frame: 0,
                    value: camera.position.x
                });
                keys.push({
                    frame: 5,
                    value: haloCenter.x
                });

                animationZoomIn.setKeys(keys);
                camera.animations.push(animationZoomIn);

                var animationZoomIn2 = new BABYLON.Animation("animationZoomIn", "position.z", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT,
                    BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                var keys2 = [];
                keys2.push({
                    frame: 0,
                    value: camera.position.z
                });
                keys2.push({
                    frame: 5,
                    value: haloCenter.z
                });

                animationZoomIn2.setKeys(keys2);
                camera.animations.push(animationZoomIn2);

                
                var animationZoomIn3 = new BABYLON.Animation("animationZoomIn", "position.y", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT,
                    BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                var keys3 = [];
                keys3.push({
                    frame: 0,
                    value: camera.position.y
                });
                keys3.push({
                    frame: 5,
                    value: haloCenter.y + 3
                });

                animationZoomIn3.setKeys(keys3);
                camera.animations.push(animationZoomIn3);

                scene.beginAnimation(camera, 0, 5, false, 1);
            }

            ///Animation für PC Nutzung
            function teleportCameratoMouse(camera, scene, mousePos) {
                camera.animations = [];

                var animationZoomIn = new BABYLON.Animation("animationZoomInMouse", "position.x", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT,
                    BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                var keys = [];
                keys.push({
                    frame: 0,
                    value: camera.position.x
                });
                keys.push({
                    frame: 5,
                    value: mousePos.x
                });

                animationZoomIn.setKeys(keys);
                camera.animations.push(animationZoomIn);

                var animationZoomIn2 = new BABYLON.Animation("animationZoomInMouse", "position.z", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT,
                    BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                var keys2 = [];
                keys2.push({
                    frame: 0,
                    value: camera.position.z
                });
                keys2.push({
                    frame: 5,
                    value: mousePos.z
                });

                animationZoomIn2.setKeys(keys2);
                camera.animations.push(animationZoomIn2);

                
                var animationZoomIn3 = new BABYLON.Animation("animationZoomInMouse", "position.y", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT,
                    BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                var keys3 = [];
                keys3.push({
                    frame: 0,
                    value: camera.position.y
                });
                keys3.push({
                    frame: 5,
                    value: mousePos.y + 3
                });

                animationZoomIn3.setKeys(keys3);
                camera.animations.push(animationZoomIn3);

                scene.beginAnimation(camera, 0, 5, false, 1);
            }
            ///////////////////Ende////Kamera Teleportationanimation///////////////////////////////////////
         

            var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
            var scene = createScene();

            //////Renderloop updated Szene
            engine.runRenderLoop(function () {
                if (scene) {
                    scene.render();
                }
            });

            // Resize
            window.addEventListener("resize", function () {
                engine.resize();
            });
            
        </script>
    </body>
</html>


